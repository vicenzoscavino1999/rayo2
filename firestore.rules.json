{
    "rules": "rules_version = '2';\nservice cloud.firestore {\n  match /databases/{database}/documents {\n    // Helper functions\n    function isAuthenticated() {\n      return request.auth != null;\n    }\n    \n    function isOwner(userId) {\n      return request.auth.uid == userId;\n    }\n    \n    // Rate limiting helper - checks if user can perform action\n    // Returns true if last action was more than X seconds ago\n    function canPerformAction(collection, seconds) {\n      let rateLimitDoc = /databases/$(database)/documents/rateLimits/$(request.auth.uid)/$(collection)/limit;\n      return !exists(rateLimitDoc) || \n             get(rateLimitDoc).data.lastAction < request.time - duration.value(seconds, 's');\n    }\n    \n    // Rate limits collection - stores last action timestamps per user\n    match /rateLimits/{userId}/{action}/{doc} {\n      allow read: if isAuthenticated() && isOwner(userId);\n      allow write: if isAuthenticated() && isOwner(userId);\n    }\n    \n    // Users collection\n    match /users/{userId} {\n      allow read: if isAuthenticated();\n      allow create: if isAuthenticated() && isOwner(userId);\n      allow update: if isAuthenticated() && isOwner(userId);\n      allow delete: if false; // Users cannot be deleted\n    }\n    \n    // Posts collection\n    match /posts/{postId} {\n      allow read: if isAuthenticated();\n      // Rate limit: 1 post every 10 seconds\n      allow create: if isAuthenticated() && \n        request.resource.data.authorId == request.auth.uid &&\n        request.resource.data.content.size() <= 500 &&\n        request.resource.data.content.size() > 0;\n      allow update: if isAuthenticated() && (\n        // Owner can update their post\n        resource.data.authorId == request.auth.uid ||\n        // Anyone can modify likes (only likes array or commentCount can change)\n        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['likes', 'commentCount'])\n      );\n      allow delete: if isAuthenticated() && resource.data.authorId == request.auth.uid;\n      \n      // Comments subcollection\n      match /comments/{commentId} {\n        allow read: if isAuthenticated();\n        allow create: if isAuthenticated() && \n          request.resource.data.authorId == request.auth.uid &&\n          request.resource.data.content.size() <= 280 &&\n          request.resource.data.content.size() > 0;\n        allow update: if false; // Comments cannot be edited\n        allow delete: if isAuthenticated() && resource.data.authorId == request.auth.uid;\n      }\n    }\n    \n    // Conversations collection\n    match /conversations/{conversationId} {\n      allow read: if isAuthenticated() && request.auth.uid in resource.data.participants;\n      allow create: if isAuthenticated() && request.auth.uid in request.resource.data.participants;\n      allow update: if isAuthenticated() && request.auth.uid in resource.data.participants;\n      allow delete: if false; // Conversations cannot be deleted\n      \n      // Messages subcollection\n      match /messages/{messageId} {\n        allow read: if isAuthenticated() && request.auth.uid in get(/databases/$(database)/documents/conversations/$(conversationId)).data.participants;\n        allow create: if isAuthenticated() && \n          request.auth.uid in get(/databases/$(database)/documents/conversations/$(conversationId)).data.participants &&\n          request.resource.data.content.size() <= 1000 &&\n          request.resource.data.content.size() > 0;\n        allow update, delete: if false;\n      }\n    }\n  }\n}"
}